# Email Agent Platform - Quick Start Deployment

## ğŸš€ Fast Track to Production

This guide gets you from zero to deployed in ~30 minutes.

## Prerequisites

- AWS CLI configured for account `713220200108`
- kubectl configured for EKS cluster `jhb-streampulse-cluster`
- Docker installed
- Google Cloud account (for Gmail OAuth)

## Step 1: AWS Infrastructure Setup (10 minutes)

Run the automated setup script:

```bash
cd email-agent
bash setup-aws-infrastructure.sh
```

This creates:
- âœ… Cognito User Pool for authentication
- âœ… S3 bucket for attachments
- âœ… Secrets Manager secrets
- âœ… IAM role for EKS pods

**Save the output** - you'll need the Cognito User Pool ID and Client ID.

## Step 2: Google OAuth Setup (5 minutes)

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create project or select existing
3. Enable **Gmail API**
4. Create **OAuth 2.0 Client ID** (Web application)
5. Add redirect URI: `https://your-domain.com/api/v1/gmail/oauth/callback`
   - For testing: `http://localhost:8000/api/v1/gmail/oauth/callback`
6. Copy Client ID and Client Secret

## Step 3: Configure Secrets (2 minutes)

Edit `k8s/secret.yaml` (generated by setup script):

```bash
vi k8s/secret.yaml
```

Update these values:
- `GOOGLE_CLIENT_ID`: From step 2
- `GOOGLE_CLIENT_SECRET`: From step 2
- `GOOGLE_REDIRECT_URI`: Your callback URL
- `ANTHROPIC_API_KEY`: Your Anthropic API key (get from https://console.anthropic.com/)
- `DATABASE_URL`: If using RDS, update with RDS endpoint
- `REDIS_URL`: If using ElastiCache, update with Redis endpoint

## Step 4: Database Setup (3 minutes)

### Option A: Use In-Cluster PostgreSQL (Quick Start)

The deployment script will create PostgreSQL automatically. Skip to Step 5.

### Option B: Use RDS (Production)

```bash
# Create RDS instance
aws rds create-db-instance \
  --db-instance-identifier email-agent-db \
  --db-instance-class db.t3.medium \
  --engine postgres \
  --engine-version 15.4 \
  --master-username emailagent \
  --master-user-password YOUR_PASSWORD \
  --allocated-storage 20 \
  --storage-encrypted \
  --region us-east-1

# Wait for instance to be available (~5 minutes)
aws rds wait db-instance-available --db-instance-identifier email-agent-db

# Get endpoint
aws rds describe-db-instances \
  --db-instance-identifier email-agent-db \
  --query 'DBInstances[0].Endpoint.Address' \
  --output text
```

Update `DATABASE_URL` in `k8s/secret.yaml` with RDS endpoint.

## Step 5: Run Database Migrations (2 minutes)

```bash
cd backend

# Install dependencies (if not already done)
pip install -r requirements.txt

# Set DATABASE_URL
export DATABASE_URL="postgresql+asyncpg://emailagent:password@your-db-host:5432/emailagent"

# Run migrations
alembic upgrade head
```

## Step 6: Deploy to EKS (5 minutes)

```bash
cd ..  # Back to email-agent directory
bash deploy-to-eks.sh
```

This will:
1. Build Docker images
2. Push to ECR
3. Deploy to Kubernetes
4. Wait for pods to be ready
5. Display application URL

## Step 7: Verify Deployment (2 minutes)

```bash
# Check pods are running
kubectl get pods -n email-agent

# Check services
kubectl get svc -n email-agent

# Get application URL
kubectl get ingress email-agent-ingress -n email-agent

# Test health endpoint
INGRESS_URL=$(kubectl get ingress email-agent-ingress -n email-agent -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
curl http://$INGRESS_URL/health
```

Expected response:
```json
{"status": "healthy", "timestamp": "2024-..."}
```

## Step 8: Create Admin User (1 minute)

```bash
# Get Cognito User Pool ID from setup script output
USER_POOL_ID="us-east-1_XXXXXXXXX"

# Create admin user
aws cognito-idp admin-create-user \
  --user-pool-id $USER_POOL_ID \
  --username admin@example.com \
  --user-attributes Name=email,Value=admin@example.com Name=email_verified,Value=true \
  --temporary-password TempPassword123! \
  --region us-east-1

# Add to Admin group
aws cognito-idp admin-add-user-to-group \
  --user-pool-id $USER_POOL_ID \
  --username admin@example.com \
  --group-name Admin \
  --region us-east-1
```

## Step 9: Access Application

Open your browser to the ALB URL:

```bash
echo "Application URL: http://$INGRESS_URL"
```

1. Click "Register" or use admin credentials from Step 8
2. Login with email and password
3. Connect Gmail account
4. Start managing emails with AI!

## Optional: Custom Domain Setup

### Request SSL Certificate

```bash
aws acm request-certificate \
  --domain-name your-domain.com \
  --subject-alternative-names *.your-domain.com \
  --validation-method DNS \
  --region us-east-1
```

### Update Ingress

Edit `k8s/ingress.yaml`:

```yaml
annotations:
  alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:713220200108:certificate/YOUR-CERT-ID
```

Redeploy:

```bash
kubectl apply -f k8s/ingress.yaml
```

### Configure DNS

Create CNAME record:
```
your-domain.com â†’ ALB-hostname
```

## Troubleshooting

### Pods not starting

```bash
kubectl describe pod <pod-name> -n email-agent
kubectl logs <pod-name> -n email-agent
```

### Database connection failed

Check DATABASE_URL in secret:
```bash
kubectl get secret email-agent-secrets -n email-agent -o yaml
```

### OAuth redirect mismatch

Ensure GOOGLE_REDIRECT_URI matches exactly in:
1. Google Cloud Console
2. k8s/secret.yaml

### Images not pulling

```bash
# Re-authenticate with ECR
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 713220200108.dkr.ecr.us-east-1.amazonaws.com

# Rebuild and push
cd email-agent
bash deploy-to-eks.sh
```

## Monitoring

### View Logs

```bash
# Backend logs
kubectl logs -f deployment/email-agent-backend -n email-agent

# Frontend logs
kubectl logs -f deployment/email-agent-frontend -n email-agent
```

### Check Metrics

```bash
# Port forward to metrics endpoint
kubectl port-forward svc/email-agent-backend 9090:9090 -n email-agent

# Open http://localhost:9090/metrics
```

### Check Auto-Scaling

```bash
kubectl get hpa -n email-agent
```

## Scaling

### Manual Scaling

```bash
kubectl scale deployment email-agent-backend --replicas=5 -n email-agent
```

### Auto-Scaling (Already Configured)

HPA automatically scales based on:
- CPU > 70%
- Memory > 80%
- Min replicas: 2
- Max replicas: 10

## Next Steps

1. **Set up monitoring**: Configure CloudWatch dashboards
2. **Enable backups**: Set up RDS automated backups
3. **Configure CI/CD**: Automate deployments with GitHub Actions
4. **Load testing**: Test with realistic traffic
5. **Security audit**: Review IAM permissions and network policies

## Support

- **Logs**: `kubectl logs -f deployment/email-agent-backend -n email-agent`
- **Spec docs**: `.kiro/specs/email-agent-platform/`
- **GitHub**: https://github.com/alpfr/cloudformation.git (branch: scripts-01)

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Internet                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                    â”‚   ALB   â”‚ (HTTPS/HTTP)
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚Frontend â”‚     â”‚ Backend â”‚     â”‚ Backend â”‚
   â”‚  Nginx  â”‚     â”‚   API   â”‚     â”‚   API   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                        â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚               â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚    â”‚  Redis  â”‚     â”‚   S3    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components**:
- **Frontend**: React SPA served by Nginx
- **Backend**: FastAPI with LangGraph AI agent
- **Database**: PostgreSQL (RDS or in-cluster)
- **Cache**: Redis (ElastiCache or in-cluster)
- **Storage**: S3 for email attachments
- **Auth**: AWS Cognito
- **Secrets**: AWS Secrets Manager

---

**Deployment Time**: ~30 minutes
**Status**: Production-ready MVP
**Last Updated**: 2024
